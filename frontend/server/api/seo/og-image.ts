// Copyright (c) 2025 The Linux Foundation and each contributor.
// SPDX-License-Identifier: MIT
import sharp from 'sharp';
import {fetchFromTinybird} from "~~/server/data/tinybird/tinybird";
import type {ProjectRepository, ProjectTinybird} from "~~/types/project";
import {getRepoNameFromUrl, getRepoSlugFromName} from "~~/server/helpers/repository.helpers";
import {INTER_REGULAR_FONT} from "~~/server/constants/inter-regular-font";
import {INTER_BOLD_FONT} from "~~/server/constants/inter-bold-font";
import {INTER_LIGHT_FONT} from "~~/server/constants/inter-light-font";
/* eslint-disable max-len, vue/max-len */

const getImageBuffer = async (url: string) => $fetch<ArrayBuffer>(url, {
        responseType: 'arrayBuffer',
    })

const imageUrlToBase64 = async (url: string) => {
    const headRes = await $fetch.raw(url, { method: 'HEAD' });
    const contentType = headRes.headers.get('content-type') || 'application/octet-stream';

    const imageBuffer = await getImageBuffer(url)

    const base64 = Buffer.from(imageBuffer).toString('base64');
    return `data:${contentType};base64,${base64}`;
}

export default defineEventHandler(async (event) => {
    const {projectSlug, repositorySlug} = getQuery(event) as Record<string, string>;
    const config = useRuntimeConfig();
    try {
        const res = await fetchFromTinybird<ProjectTinybird[]>('/v0/pipes/projects_list.json', {
            slug: projectSlug,
        });
        if (!res.data || res.data.length === 0) {
            setHeader(event, 'Content-Type', 'image/png');
            const buff = await getImageBuffer(`${config.public.appUrl}/og-image.png`);
            return Buffer.from(buff);
        }
        const project: ProjectTinybird = res.data[0];
        const repository = project.repositories.map((repoUrl) => {
            const name = getRepoNameFromUrl(repoUrl);
            const slug = getRepoSlugFromName(name);
            return {
                url: repoUrl,
                name,
                slug,
            }
        }).find((repo) => repo.slug === repositorySlug)

        let base64Logo = '';
        if(project.logo?.length > 0){
            base64Logo = await imageUrlToBase64(project.logo)
        }
        else {
            base64Logo = await imageUrlToBase64(`${config.public.appUrl}/images/fallback-logo.png`);
        }

        const svg = svgTemplate({
            ...project,
            logo: base64Logo,
        }, repository)
        const pngBuffer = await sharp(Buffer.from(svg))
            .resize(1200, 630)
            .jpeg()
            .toBuffer();

        setHeader(event, 'Content-Type', 'image/jpeg');
        return pngBuffer;
    } catch (err) {
        console.error(err);
        setHeader(event, 'Content-Type', 'image/png');
        const buff = await getImageBuffer(`${config.public.appUrl}/og-image.png`);
        return Buffer.from(buff);
    }
});

function svgTemplate(project: ProjectTinybird, repository: ProjectRepository | undefined) {
    const projectName: string = project.name.length > 30 ? `${project.name.substring(0, 29)}...` : project.name;
    const projectLogo: string = project.logo;
    const projectDescription: string = project.description.length > 65 ? `${project.description.substring(0, 65)}...` : project.description;
    let repositoryName: string | undefined = repository?.name?.split('/').at(-1) || '';
    repositoryName = repositoryName && repositoryName.length > 40 ? `${repositoryName.substring(0, 39)}...` : repositoryName;
    return `<?xml version="1.0" encoding="UTF-8"?>
    <svg width="1200" height="630" viewBox="0 0 1200 630" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <style>
    @font-face {
      font-family: 'Inter';
      font-weight: 300;
      src: url('data:font/woff2;base64,${INTER_LIGHT_FONT}') format('woff2');
    }
    @font-face {
      font-family: 'Inter';
      font-weight: 400;
      src: url('data:font/woff2;base64,${INTER_REGULAR_FONT}') format('woff2');
    }

    @font-face {
      font-family: 'Inter';
      font-weight: 700;
      src: url('data:font/woff2;base64,${INTER_BOLD_FONT}') format('woff2');
    }

    .text-light {
      font-family: 'Inter';
      font-weight: 300;
      letter-spacing: 0.008em
    }

    .text-regular {
      font-family: 'Inter';
      font-weight: 400;
    }

    .text-bold {
      font-family: 'Inter';
      font-weight: 700;
    }
  </style>

    <g clip-path="url(#clip0_3832_17336)">
        <rect width="1200" height="630" fill="white"/>
        <circle cx="1200" r="630" fill="url(#paint0_radial_3832_17336)"/>
        <path d="M89.2995 117.526V98.8187H80V126.826H108.007V117.526H89.2995Z" fill="#0094FF"/>
        <path d="M126.606 80.1094H80V94.1671H89.2995V89.5172H117.306V117.525H112.657V126.824H126.606V80.1094Z" fill="#003778"/>
        <path d="M136.016 80H150.397V114.82H171.159V126.823H136.016V80Z" fill="#003778"/>
        <path d="M180.365 80H216.59V92.0031H194.855V97.8425H213.562V108.981H194.855V126.823H180.365V80Z" fill="#003778"/>
        <path d="M237.884 101.953L222.529 80.1094H239.398L246.426 92.7613L253.347 80.1094H269.243L254.32 102.061L270.973 126.716H253.671L245.778 112.875L237.559 126.824H221.123L237.884 101.953Z" fill="#0094FF"/>
        <path d="M488.225 103.973C488.188 102.887 487.963 101.95 487.551 101.164C487.139 100.34 486.577 99.6653 485.866 99.1409C485.191 98.6165 484.405 98.2419 483.506 98.0171C482.607 97.7549 481.652 97.6238 480.64 97.6238C479.854 97.6238 479.048 97.7175 478.224 97.9048C477.438 98.0546 476.707 98.3355 476.033 98.7476C475.359 99.1222 474.816 99.6278 474.404 100.265C473.992 100.901 473.785 101.688 473.785 102.625C473.785 103.411 473.973 104.085 474.347 104.647C474.759 105.172 475.265 105.621 475.864 105.996C476.464 106.37 477.119 106.689 477.831 106.951C478.543 107.176 479.198 107.363 479.797 107.513L484.517 108.58C485.528 108.73 486.521 109.011 487.495 109.423C488.506 109.798 489.387 110.304 490.136 110.94C490.922 111.577 491.559 112.364 492.046 113.3C492.533 114.237 492.777 115.342 492.777 116.615C492.777 118.189 492.421 119.537 491.709 120.661C490.997 121.747 490.08 122.646 488.956 123.358C487.87 124.032 486.633 124.519 485.248 124.819C483.862 125.118 482.494 125.268 481.146 125.268C477.737 125.268 474.965 124.463 472.83 122.852C470.733 121.241 469.534 118.657 469.234 115.098H472.774C472.924 117.496 473.785 119.312 475.359 120.548C476.969 121.747 478.955 122.346 481.314 122.346C482.176 122.346 483.056 122.253 483.955 122.065C484.892 121.878 485.753 121.56 486.54 121.11C487.326 120.661 487.963 120.099 488.45 119.425C488.975 118.713 489.237 117.851 489.237 116.84C489.237 115.978 489.049 115.267 488.675 114.705C488.338 114.106 487.87 113.619 487.27 113.244C486.671 112.832 485.978 112.495 485.191 112.233C484.442 111.97 483.674 111.746 482.888 111.558L478.337 110.547C477.175 110.247 476.108 109.91 475.134 109.536C474.16 109.124 473.299 108.637 472.549 108.075C471.838 107.475 471.276 106.764 470.864 105.94C470.452 105.078 470.246 104.029 470.246 102.793C470.246 101.332 470.564 100.077 471.201 99.0285C471.875 97.9797 472.737 97.1369 473.785 96.5001C474.834 95.8633 475.995 95.395 477.269 95.0954C478.58 94.7957 479.872 94.6459 481.146 94.6459C482.607 94.6459 483.955 94.8332 485.191 95.2078C486.465 95.5823 487.57 96.1629 488.506 96.9496C489.48 97.7362 490.248 98.7101 490.81 99.8713C491.372 101.033 491.69 102.4 491.765 103.973H488.225Z" fill="#003778"/>
        <path d="M459.854 95.4921H465.754V98.47H459.854V118.023C459.854 119.185 460.004 120.102 460.304 120.777C460.641 121.413 461.446 121.769 462.72 121.844C463.731 121.844 464.743 121.788 465.754 121.676V124.653C465.23 124.653 464.705 124.672 464.181 124.71C463.656 124.747 463.132 124.766 462.607 124.766C460.248 124.766 458.6 124.316 457.663 123.417C456.727 122.481 456.277 120.777 456.315 118.304V98.47H451.258V95.4921H456.315V86.783H459.854V95.4921Z" fill="#003778"/>
        <path d="M423.986 84.3646H427.526V100.49H427.638C428.313 98.7299 429.511 97.3252 431.234 96.2764C432.957 95.1901 434.849 94.647 436.909 94.647C438.932 94.647 440.618 94.9092 441.966 95.4336C443.352 95.958 444.457 96.7072 445.281 97.6811C446.105 98.6176 446.686 99.7788 447.023 101.165C447.36 102.551 447.528 104.105 447.528 105.828V124.483H443.989V106.39C443.989 105.154 443.876 104.012 443.652 102.963C443.427 101.876 443.034 100.94 442.472 100.153C441.91 99.3667 441.142 98.7487 440.168 98.2992C439.232 97.8497 438.052 97.6249 436.628 97.6249C435.205 97.6249 433.931 97.8871 432.808 98.4115C431.721 98.8985 430.785 99.5915 429.998 100.49C429.249 101.352 428.65 102.401 428.2 103.637C427.788 104.836 427.564 106.147 427.526 107.57V124.483H423.986V84.3646Z" fill="#003778"/>
        <path d="M417.335 122.122C417.335 124.257 417.092 126.186 416.605 127.909C416.155 129.632 415.425 131.093 414.413 132.292C413.402 133.49 412.072 134.408 410.424 135.045C408.814 135.682 406.828 136 404.468 136C403.008 136 401.584 135.831 400.198 135.494C398.812 135.157 397.557 134.633 396.434 133.921C395.347 133.209 394.43 132.292 393.681 131.168C392.969 130.082 392.557 128.771 392.444 127.235H395.984C396.172 128.321 396.527 129.22 397.052 129.932C397.614 130.681 398.269 131.28 399.018 131.73C399.805 132.179 400.666 132.498 401.603 132.685C402.539 132.91 403.495 133.022 404.468 133.022C407.765 133.022 410.143 132.086 411.604 130.213C413.065 128.34 413.795 125.643 413.795 122.122V118.189H413.683C412.859 119.987 411.642 121.429 410.031 122.515C408.458 123.601 406.604 124.144 404.468 124.144C402.146 124.144 400.161 123.77 398.513 123.021C396.865 122.234 395.497 121.166 394.411 119.818C393.362 118.469 392.594 116.896 392.107 115.098C391.62 113.263 391.377 111.315 391.377 109.255C391.377 107.269 391.658 105.396 392.22 103.636C392.819 101.838 393.662 100.283 394.748 98.9723C395.872 97.6238 397.239 96.575 398.85 95.8258C400.498 95.0392 402.371 94.6459 404.468 94.6459C405.555 94.6459 406.566 94.7957 407.502 95.0954C408.476 95.395 409.357 95.8258 410.143 96.3877C410.93 96.9121 411.623 97.5302 412.222 98.2419C412.859 98.9536 413.346 99.7028 413.683 100.489H413.795V95.4887H417.335V122.122ZM404.468 121.166C406.004 121.166 407.353 120.848 408.514 120.211C409.675 119.537 410.649 118.675 411.436 117.627C412.222 116.54 412.803 115.304 413.177 113.918C413.589 112.532 413.795 111.109 413.795 109.648C413.795 108.225 413.627 106.801 413.29 105.378C412.953 103.954 412.409 102.662 411.66 101.501C410.911 100.34 409.937 99.4031 408.739 98.6914C407.577 97.9797 406.154 97.6238 404.468 97.6238C402.783 97.6238 401.341 97.9797 400.142 98.6914C398.943 99.3656 397.951 100.265 397.164 101.388C396.378 102.512 395.797 103.804 395.422 105.265C395.085 106.689 394.917 108.15 394.917 109.648C394.917 111.109 395.104 112.532 395.479 113.918C395.853 115.304 396.434 116.54 397.22 117.627C398.007 118.675 399 119.537 400.198 120.211C401.397 120.848 402.82 121.166 404.468 121.166Z" fill="#003778"/>
        <path d="M382.518 84.3646H386.057V90.0396H382.518V84.3646ZM382.518 95.4898H386.057V124.483H382.518V95.4898Z" fill="#003778"/>
        <path d="M372.782 103.973C372.745 102.887 372.52 101.95 372.108 101.164C371.696 100.34 371.134 99.6653 370.422 99.1409C369.748 98.6165 368.961 98.2419 368.062 98.0171C367.163 97.7549 366.208 97.6238 365.197 97.6238C364.41 97.6238 363.605 97.7175 362.781 97.9048C361.994 98.0546 361.264 98.3355 360.59 98.7476C359.915 99.1222 359.372 99.6278 358.96 100.265C358.548 100.901 358.342 101.688 358.342 102.625C358.342 103.411 358.529 104.085 358.904 104.647C359.316 105.172 359.822 105.621 360.421 105.996C361.02 106.37 361.676 106.689 362.388 106.951C363.099 107.176 363.755 107.363 364.354 107.513L369.074 108.58C370.085 108.73 371.078 109.011 372.052 109.423C373.063 109.798 373.943 110.304 374.692 110.94C375.479 111.577 376.116 112.364 376.603 113.3C377.09 114.237 377.333 115.342 377.333 116.615C377.333 118.189 376.977 119.537 376.266 120.661C375.554 121.747 374.636 122.646 373.513 123.358C372.426 124.032 371.19 124.519 369.804 124.819C368.418 125.118 367.051 125.268 365.703 125.268C362.294 125.268 359.522 124.463 357.387 122.852C355.289 121.241 354.091 118.657 353.791 115.098H357.331C357.481 117.496 358.342 119.312 359.915 120.548C361.526 121.747 363.511 122.346 365.871 122.346C366.733 122.346 367.613 122.253 368.512 122.065C369.448 121.878 370.31 121.56 371.096 121.11C371.883 120.661 372.52 120.099 373.007 119.425C373.531 118.713 373.793 117.851 373.793 116.84C373.793 115.978 373.606 115.267 373.232 114.705C372.894 114.106 372.426 113.619 371.827 113.244C371.228 112.832 370.535 112.495 369.748 112.233C368.999 111.97 368.231 111.746 367.444 111.558L362.893 110.547C361.732 110.247 360.665 109.91 359.691 109.536C358.717 109.124 357.855 108.637 357.106 108.075C356.394 107.475 355.832 106.764 355.42 105.94C355.008 105.078 354.802 104.029 354.802 102.793C354.802 101.332 355.121 100.077 355.758 99.0285C356.432 97.9797 357.293 97.1369 358.342 96.5001C359.391 95.8633 360.552 95.395 361.826 95.0954C363.137 94.7957 364.429 94.6459 365.703 94.6459C367.163 94.6459 368.512 94.8332 369.748 95.2078C371.022 95.5823 372.127 96.1629 373.063 96.9496C374.037 97.7362 374.805 98.7101 375.367 99.8713C375.929 101.033 376.247 102.4 376.322 103.973H372.782Z" fill="#003778"/>
        <path d="M325.189 95.4887H328.729V100.489H328.842C329.516 98.7288 330.714 97.3242 332.438 96.2753C334.161 95.189 336.052 94.6459 338.112 94.6459C340.135 94.6459 341.821 94.9081 343.169 95.4325C344.555 95.9569 345.66 96.7061 346.484 97.68C347.308 98.6165 347.889 99.7777 348.226 101.164C348.563 102.55 348.732 104.104 348.732 105.827V124.482H345.192V106.389C345.192 105.153 345.079 104.01 344.855 102.962C344.63 101.875 344.237 100.939 343.675 100.152C343.113 99.3656 342.345 98.7476 341.371 98.2981C340.435 97.8486 339.255 97.6238 337.831 97.6238C336.408 97.6238 335.134 97.886 334.011 98.4104C332.924 98.8974 331.988 99.5904 331.201 100.489C330.452 101.351 329.853 102.4 329.403 103.636C328.991 104.835 328.767 106.146 328.729 107.569V124.482H325.189V95.4887Z" fill="#003778"/>
        <path d="M313.744 84.3646H317.565V124.483H313.744V84.3646Z" fill="#003778"/>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M290.119 126.823V80H291.29V126.823H290.119Z" fill="#CCCCCC"/>
        <rect x="979" y="409" width="142" height="142" rx="21" fill="#fff" stroke="#E2E8F0" stroke-width="2"/>
        <rect x="979" y="409" width="142" height="142" rx="21" fill="url(#pattern0_3832_17336)" stroke="#E2E8F0" stroke-width="2"/>
          <text x="76" y="476"
                font-size="48"
                fill="black">
  <tspan class="text-bold">${projectName}</tspan>
          </text>
          ${repositoryName?.length > 0 ? `<text x="79" y="529"
                font-size="40"
                fill="black"
                class="text-light">
                / ${repositoryName}
          </text>` : `<text x="79" y="529"
                font-size="24"
                fill="#64748B"
                class="text-light">
                ${projectDescription}
          </text>`}
        <path d="M80 370L1120 370" stroke="#ADD6FF"/>
    </g>
    <defs>
        <pattern id="pattern0_3832_17336" patternContentUnits="objectBoundingBox" width="1" height="1">
            <use xlink:href="#image0_3832_17336" transform="scale(0.00390625)"/>
        </pattern>
        <radialGradient id="paint0_radial_3832_17336" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(1200) rotate(90) scale(630)">
            <stop stop-color="#EBF5FF"/>
            <stop offset="1" stop-color="white"/>
        </radialGradient>
        <clipPath id="clip0_3832_17336">
            <rect width="1200" height="630" fill="white"/>
</clipPath>
<image id="image0_3832_17336" width="256" height="256" preserveAspectRatio="xMidYMid meet" xlink:href="${projectLogo}"/>
    </defs>
</svg>`
}
